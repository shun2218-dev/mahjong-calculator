# 麻雀 点数計算ロジック (Mahjong Score Calculator)

TypeScriptで構築された、麻雀の点数計算（符計算・翻計算）を行うためのコアロジックライブラリです。

複雑なアガリ形の解析、40種類以上の役判定（役満・ダブル役満含む）、競合処理（例：「清一色」と「混一色」）、例外的な符計算（ピンフ・七対子）、ドラ計算、最終的な点数計算までを、クラスベースの「Composition（合成）」パターンを用いてカプセル化・分離しています。

## 主な機能

* **アガリ形解析 (HandParser):**
    * スタンダード形（4面子1雀頭）、七対子、国士無双の3パターンを自動で判定します。
    * 雀頭の抜き出しと面子の再帰的探索（バックトラック）により、複雑な手牌（例: `[11123p]`）も正しく分解します。
* **役判定 (YakuJudger):**
    * 「マネージャー」クラスが、役ごとに分割された「専門家（Checker）」クラスを呼び出します。
    * 役満、通常役、状況役（リーチ、海底など）をすべて判定します。
    * 赤ドラ、表ドラ、裏ドラ（槓ウラ含む）を計算します。
* **競合処理 (resolveConflicts):**
    * 「清一色」と「混一色」
    * 「二盃口」と「一盃口」
    * 「純全帯么九」と「混全帯么九」
    * 「ダブル立直」と「立直」
    * 上記のような上位役が成立した場合、下位の役を自動的に除外します。
* **符計算 (FuCalculator):**
    * ピンフ（ツモ20符、ロン30符）と七対子（25符）の例外ルールに対応しています。
    * 面子（暗刻・明刻・暗槓・明槓）の符、雀頭（役牌・連風牌）の符、待ち（カンチャンなど）の符を正確に計算し、切り上げます。
* **点数計算 (PointCalculator):**
    * 算出された「翻」と「符」に基づき、満貫、跳満、倍満、三倍満、役満（ダブル役満・数え役満含む）の点数を算出します。
    * 親/子、ロン/ツモに応じた支払い点（`total`, `oya`, `ko`）を返します。

## 技術スタック

* **TypeScript**: 主要なロジック
* **Vitest**: ユニットテスト及びカバレッジ

## プロジェクト構成

ロジックは「関心の分離」と「高凝集」の原則に基づき、各クラスに分割されています。

## APIエンドポイント (予定)

このロジックは `MahjongScoreService` を通じて、API（NestJSなど）として公開されることを想定しています。

### `POST /calculate`

アガリ情報をJSON形式で送信し、計算された点数結果を受け取ります。

---

### 📥 入力 (Request) の例

**`CalculateRequestDto`** 型のJSONデータです。
（例：メンゼン・ピンフ・ツモ・ドラ1 の手）

```json
{
  "tehai": [
    "1m", "2m", "3m", "4m", "5m", "6m", 
    "7p", "8p", "9p", 
    "1s", "1s", "2s", "3s"
  ],
  "agariHai": "4s",
  "agariType": "tsumo", // "tsumo" or "ron"
  "fuuro": [], // ex) { type: "pon", tiles: ["1m", "1m", "1m"] }
  "status": {
    "bakaze": "ton",
    "jikaze": "nan",
    "isRiichi": false, // optional
    "isIppatsu": false, // optional
    "isHaitei": false, // optional
    "isRinshan": false, // optional
    "isChankan": false, // optional
    "dora": ["2s"],
    "uradora": []
  }
}
```
### 📤 出力 (Response) の例
PointResult 型のJSONデータが返されます。 （上記インプットに対する計算結果）
* 役: 門前清自摸和 (1翻) + 平和 (1翻)
* ドラ: ドラ表示牌 2s → ドラ 3s が1枚
* 合計: 3翻
* 符: 20符 (ピンフ・ツモの例外ルール)
* 点数: 20符3翻（子・ツモ） → 700点 / 1300点
```json
{
  "total": 2700,
  "oya": 1300,
  "ko": 700,
  "name": "20符3翻"
}
```